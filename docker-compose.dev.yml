version: '3.9'

services:
  # ---------- SQL Server ----------
  autoship-sql:
    build:
      context: ./docker/sql
    container_name: autoship-sql
    environment:
      SA_PASSWORD: ${SA_PASSWORD}  # make sure this meets SQL Server requirements
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer"
    ports:
      - "1433:1433"  # map SQL Server port
    volumes:
      - autoship_sql_data:/var/opt/mssql
    networks:
      - autoship-network
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools/bin/sqlcmd -U sa -P ${SA_PASSWORD} -Q 'SELECT 1' || exit 1"]
      interval: 10s
      retries: 10

  # ---------- Backend (.NET) ----------
  autoship-backend:
    build:
      context: ./backend/AutoShip
      dockerfile: Dockerfile.dev
    container_name: autoship-backend
    env_file:
      - .env
    environment:
      Jwt__Key: ${JWT_KEY}
      EmailSettings__Username: ${EMAIL_USERNAME}
      EmailSettings__Password: ${EMAIL_PASSWORD}
      ConnectionStrings__DefaultConnection: "Server=autoship-sql,1433;Database=AutoShipDb;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=True;"
      AzureBlobStorage__ConnectionString: ${AzureBlobStorage__ConnectionString}
      AzureBlobStorage__ContainerName: uploads
      DOTNET_ENVIRONMENT: Development

    ports:
      - "5065:5000"   # backend API port
    depends_on:
      autoship-sql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 15s
    networks:
      - autoship-network
    volumes:
      - ./backend/AutoShip:/app
    command: ["dotnet", "watch", "run", "--urls", "http://0.0.0.0:5000"]

  # ---------- Frontend (Vite) ----------
  autoship-frontend:
    build:
      context: ./frontend/Webclient
      dockerfile: Dockerfile.dev
    container_name: autoship-frontend
    ports:
      - "5173:5173"  # expose Vite frontend
    depends_on:
      autoship-backend:
        condition: service_healthy
    networks:
      - autoship-network
    volumes:
      - ./frontend/Webclient:/app
      - /app/node_modules 
    command: ["npm", "run", "dev", "--", "--host"]  # <-- important: bind to 0.0.0.0

# ---------- Volumes ----------
volumes:
  autoship_sql_data:

# ---------- Network ----------
networks:
  autoship-network:
    driver: bridge
